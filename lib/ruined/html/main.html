<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html> <head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
 <meta http-equiv="content-style-type" content="text/css"/>
 <title></title>
 <link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.5.custom.css"></link>
 <link rel="stylesheet" href="../css/ruin.css"></link>
 <script type="text/javascript" src="../js/jquery-1.4.2.min.js"></script>
 <script type="text/javascript" src="../js/jquery-ui-1.8.5.custom.min.js"></script>
 <script type="text/javascript">
var files = new Object();
var priorLine = { line: null, index: null };
var interval = 1000;
var contTimer = null;
function addFile(name, line, command) {
  var a = name.split('/');
  $('#lists').tabs('add' , '/debug/file/' + name , a[a.length - 1]);
  var index = $('#lists').tabs('length') - 1;
  $('#lists').tabs('select', index);
  $('td').bind('click', function(ev) {
    var sub = 'false';
    if (ev.currentTarget.style.backgroundColor == '') {
      sub = 'true';
    }
    var index = $('#lists').tabs('option', 'selected');
    var key, file;
    for (key in files) {
      if (files[key] == index) {
        file = key;
        break;
      }
    }
    if (file != null) {
      var line = 0;
      var list = $('#ui-tabs-' + (index * 2 + 2) + ' > table > tbody > tr > td');
      for (var i = 0; i < list.length; i++) {
        if (list[i] == ev.currentTarget) {
          line = i + 1;
          break;
        }
      }
      $.get('/debug/break/' + sub + '/' + file + '/' + line, function() {
        var bgclr = '';
        var clr = '';
        if (sub == 'true') {
          bgclr = 'saddlebrown';
          clr = 'white';
        }
        ev.currentTarget.style.backgroundColor = bgclr;
        ev.currentTarget.style.color = clr;
      });
    }
  });
  return index;
}
function changeTab(index) {
  $('#lists').tabs('select', index);
}
function lineColor(command, brk) {
  if (command == 'cont' && !brk) {
    return 'aquamarine';
  }
  return 'yellow';
}
function stopRun() {
  clearTimeout(contTimer);
  contTimer = null;
  $('#run').button('option', 'label', 'run');
}
function setLine(index, line, command, brk) {
  if (line > 0) {
    --line;
  }
  if (priorLine.index != null) {
    var style = $('#ui-tabs-' + (priorLine.index * 2 + 2) + ' > table > tbody > tr > td')[priorLine.line].style;
    style.backgroundColor = priorLine.backgroundColor;
    style.color = priorLine.color;
  }
  var style = $('#ui-tabs-' + (index * 2 + 2) + ' > table > tbody > tr > td')[line].style;
  priorLine.index = index;
  priorLine.line = line;
  priorLine.color = style.color;
  priorLine.backgroundColor = style.backgroundColor;
  style.backgroundColor = lineColor(command, brk);
  style.color = '';
  $('#ui-tabs-' + (index * 2 + 2) + ' > table > tbody > tr > td')[line].scrollIntoView(true);
}
function stepProc(command) {
  $.getJSON('/debug/' + command, function(data) {
    if (data == null || data.file == null) {
      if (contTimer != null) stopRun();
      $('button').button('disable');
      return;
    }
    if (data['break'] || data['event'] == 'exit') {
      stopRun();
      if (data['event'] == 'exit') {
        $('button').button('disable');
        alert('program exit');
      }
    }
    if (files[data.file] == null) {
      files[data.file] = addFile(data.file, data.line, command);
    } else {
      changeTab(files[data.file]);
    }
    setLine(files[data.file], data.line, command, data['break']);
    $('#vars').tabs('load', $('#vars').tabs('option', 'selected'));
    var span = document.createElement('span');
    span.innerHTML = data.stdout;
    $('#stdout')[0].appendChild(span);
    span = document.createElement('span');
    $('#stdout')[0].appendChild(span);
    span.scrollIntoView(true);
  });
}
function contProc(command) {
  stepProc(command);
  contTimer = setTimeout('contProc("' + command + '");', interval);
}
function initTabs(elm) {
  elm.tabs();
  elm.tabs({ajaxOptions: {async: false}});
  elm.tabs('option', 'cache', true);
}
$(document).ready(function() {
  initTabs($('#lists'));
  initTabs($('#vars'));
  $('#vars').tabs({
    show: function(envet, ui) {
      $('#vars').tabs('load', $('#vars').tabs('option', 'selected'));
    }
  });
  $('#intval').slider();
  $('#intval').slider('option', 'value', 10);
  $('#intval').slider({
    change: function(e, ui) {
      interval = $('#intval').slider('option', 'value') * 100;
    }
  });
  $.ajaxSetup({cache: false});

  $('button').button();
  $('#run').click(function() {
    if (contTimer == null) {
      contProc('cont');
      $('#run').button('option', 'label', 'stop');
    } else {
      stopRun();
    }
  });
  $('#step').click(function() {
    stepProc('step');
  });
  $('#waiting').ajaxError(function() {
    if (contTimer != null) {
      stopRun();
    }
    $('#vars').tabs({
      show: function(envet, ui) {
        alert('program terminated');
      }
    });
  });
  stepProc('stepping');
});
</script>
</head>
<body>
<div class="list-pane">
  <div id="button-panel">
    <div class="console">
      <button id="step">Step</button>
      <button id="run">Run</button>
    </div>
  </div>
  <div id="speed-panel">
    <div id="intval"></div>
    <div style="float: left; width: 50%">fast &lt;----</div>
    <div style="float: right">----&gt; slow</div>
  </div>
  <div id="lists" style="clear: both">
    <ul></ul>
  </div>
</div>
<div class="vars-pane">
  <div id="vars">
    <ul>
      <li><a href="/debug/locals" title="Local Vars"><span>Local Vars</span></a></li>
      <li><a href="/debug/self" title="Self Vars"><span>Self Vars</span></a></li>
      <li><a href="/debug/globals" title="Global Vars"><span>Global Vars</span></a></li>
    </ul>
    <div id="Local_Vars"></div>
    <div id="Self_Vars"></div>
    <div id="Global_Vars"></div>    
  </div>
</div>
<div style="clear: both;">
  <div id="output">
    <span id="stdout"></span>
  </div>
  <hr>
  <div id="waiting"></div>
  <address id="ruby-platform"></address>
  <!-- hhmts start --> Last modified: Mon Oct 11 17:22:50 +0900 2010 <!-- hhmts end -->
</div>    
</body> </html>
